# üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–∞ —Å –ø–æ–¥—Å—á—ë—Ç–æ–º –ª–∞–π–∫–æ–≤

**–î–∞—Ç–∞:** 24 –æ–∫—Ç—è–±—Ä—è 2025  
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Å—á—ë—Ç –ª–∞–π–∫–æ–≤ –∏–∑-–∑–∞ SQL JOIN

## üîç –ù–∞–π–¥–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

### –°–∏–º–ø—Ç–æ–º—ã:
- –ù–∞ —ç–∫—Ä–∞–Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è 31 –ª–∞–π–∫
- API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `like_count: "3"`
- –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Ç–æ–ª—å–∫–æ 1 —Ä–µ–∞–ª—å–Ω—ã–π –ª–∞–π–∫

### –ü—Ä–∏—á–∏–Ω–∞:
SQL-–∑–∞–ø—Ä–æ—Å —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ LEFT JOIN —Å–æ–∑–¥–∞—ë—Ç –ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ (cartesian product):

```sql
LEFT JOIN video_likes vl ON v.id = vl.video_id
LEFT JOIN video_comments vc ON v.id = vc.video_id
COUNT(vl.id) as like_count  ‚Üê –ë–ê–ì!
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –í–∏–¥–µ–æ –∏–º–µ–µ—Ç 1 –ª–∞–π–∫ –∏ 3 –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
- JOIN —Å–æ–∑–¥–∞—ë—Ç 1 √ó 3 = 3 —Å—Ç—Ä–æ–∫–∏ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ
- `COUNT(vl.id)` —Å—á–∏—Ç–∞–µ—Ç –≤—Å–µ 3 —Å—Ç—Ä–æ–∫–∏ –≤–º–µ—Å—Ç–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ª–∞–π–∫–æ–≤
- –ü–æ—ç—Ç–æ–º—É API –≤–æ–∑–≤—Ä–∞—â–∞–ª `like_count: "3"` –≤–º–µ—Å—Ç–æ `"1"`

### –ü—Ä–∏–º–µ—Ä:
```
| video_id | like_id | comment_id |
|----------|---------|------------|
| video-1  | like-1  | comment-1  |  ‚Üê JOIN —Å–æ–∑–¥–∞—ë—Ç 3 —Å—Ç—Ä–æ–∫–∏
| video-1  | like-1  | comment-2  |  ‚Üê –¥–ª—è 1 –ª–∞–π–∫–∞
| video-1  | like-1  | comment-3  |  ‚Üê COUNT —Å—á–∏—Ç–∞–µ—Ç –≤—Å–µ 3!
```

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

–ó–∞–º–µ–Ω–µ–Ω–æ `COUNT(vl.id)` –Ω–∞ `COUNT(DISTINCT vl.id)` –≤ 3 –º–µ—Å—Ç–∞—Ö:

### 1. GET /api/videos/feed - –æ—Å–Ω–æ–≤–Ω–æ–π feed
**–§–∞–π–ª:** `server/routes/videos.js:103-104`
```javascript
// –ë–´–õ–û:
COUNT(vl.id) as like_count,
COUNT(vc.id) as comment_count

// –°–¢–ê–õ–û:
COUNT(DISTINCT vl.id) as like_count,
COUNT(DISTINCT vc.id) as comment_count
```

### 2. GET /api/videos/feed - –∞–¥–º–∏–Ω—Å–∫–∏–µ –≤–∏–¥–µ–æ
**–§–∞–π–ª:** `server/routes/videos.js:145-146`
```javascript
// –ë–´–õ–û:
COUNT(vl.id) as like_count,
COUNT(vc.id) as comment_count

// –°–¢–ê–õ–û:
COUNT(DISTINCT vl.id) as like_count,
COUNT(DISTINCT vc.id) as comment_count
```

### 3. GET /api/videos/:id - –æ–¥–Ω–æ –≤–∏–¥–µ–æ
**–§–∞–π–ª:** `server/routes/videos.js:639-640`
```javascript
// –ë–´–õ–û:
COUNT(vl.id) as like_count,
COUNT(vc.id) as comment_count

// –°–¢–ê–õ–û:
COUNT(DISTINCT vl.id) as like_count,
COUNT(DISTINCT vc.id) as comment_count
```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```json
{
  "likes": 1,
  "like_count": "3",  ‚Üê –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (1 –ª–∞–π–∫ √ó 3 –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è = 3)
  "comment_count": "3"
}
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```json
{
  "likes": 1,
  "like_count": "1",  ‚Üê ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
  "comment_count": "3"
}
```

## üîß –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

–ò–∑–º–µ–Ω–µ–Ω–∏—è —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã:
1. ‚úÖ –ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –≤ `/opt/mebelplace/server/routes/videos.js`
2. ‚úÖ –§–∞–π–ª —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ backend –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
3. ‚úÖ Backend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω
4. ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å API –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≤–∏–¥–µ–æ
```bash
curl -s "https://mebelplace.com.kz/api/videos/3cd91b71-e2ec-4889-b963-0ea2d4329dad" \
  | jq '.data | {likes, like_count, comment_count}'
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "likes": 1,
  "like_count": "1",
  "comment_count": "3"
}
```

### –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å feed
```bash
curl -s "https://mebelplace.com.kz/api/videos/feed?limit=1" \
  | jq '.data.videos[0] | {likes, like_count, comment_count}'
```

### –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
```bash
docker exec mebelplace-postgres psql -U mebelplace -d mebelplace -c \
  "SELECT v.id, v.likes, COUNT(DISTINCT vl.id) as real_likes 
   FROM videos v 
   LEFT JOIN video_likes vl ON v.id = vl.video_id 
   WHERE v.id = '3cd91b71-e2ec-4889-b963-0ea2d4329dad' 
   GROUP BY v.id, v.likes;"
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **COUNT vs COUNT(DISTINCT):**
   - `COUNT(id)` - —Å—á–∏—Ç–∞–µ—Ç –í–°–ï —Å—Ç—Ä–æ–∫–∏ (–≤–∫–ª—é—á–∞—è –¥—É–±–ª–∏–∫–∞—Ç—ã –∏–∑ JOIN)
   - `COUNT(DISTINCT id)` - —Å—á–∏—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –£–ù–ò–ö–ê–õ–¨–ù–´–ï –∑–Ω–∞—á–µ–Ω–∏—è

2. **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å DISTINCT:**
   - –í—Å–µ–≥–¥–∞ –ø—Ä–∏ COUNT —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ JOIN
   - –ö–æ–≥–¥–∞ JOIN –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã —Å—Ç—Ä–æ–∫
   - –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ —Å—á–∏—Ç–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏

3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
   - `COUNT(DISTINCT)` –Ω–µ–º–Ω–æ–≥–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ —á–µ–º `COUNT()`
   - –ù–æ —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–¥—Å—á—ë—Ç–∞
   - –î–ª—è –±–æ–ª—å—à–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–¥–∑–∞–ø—Ä–æ—Å—ã

## üîç –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥—Ä—É–≥–∏–µ —Ñ–∞–π–ª—ã –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø–æ—Ö–æ–∂–µ–π –ø—Ä–æ–±–ª–µ–º—ã:
```bash
grep -r "COUNT(" server/routes/ | grep -v "DISTINCT"
```

–û—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞:
- `server/routes/admin.js` - –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ—Ö–æ–∂–∞—è –ø—Ä–æ–±–ª–µ–º–∞
- –õ—é–±—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ JOIN

## üìù –í—ã–≤–æ–¥—ã

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `COUNT()` —Å JOIN  
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `COUNT(DISTINCT column)` –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ–¥—Å—á—ë—Ç–∞  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û  
**–¢–∏–ø:** SQL Bug / Data Integrity Issue

---

**–ê–≤—Ç–æ—Ä –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** AI Assistant  
**–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:** –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

