# –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ Backend MebelPlace - –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –æ–±–∑–æ—Ä](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π-–æ–±–∑–æ—Ä)
2. [–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫](#—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π-—Å—Ç–µ–∫)
3. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–ø—Ä–æ–µ–∫—Ç–∞)
4. [–î–æ–º–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏](#–¥–æ–º–µ–Ω–Ω—ã–µ-—Å—É—â–Ω–æ—Å—Ç–∏)
5. [API Endpoints](#api-endpoints)
6. [–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö](#–±–∞–∑–∞-–¥–∞–Ω–Ω—ã—Ö)
7. [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ Middleware](#–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å-–∏-middleware)
8. [–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞](#–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
9. [–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ](#–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ)
10. [Event System](#event-system)
11. [Background Jobs](#background-jobs)
12. [–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥](#–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
13. [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
14. [–ë–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å—ã](#–±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å—ã)
15. [–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã](#–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã)

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –æ–±–∑–æ—Ä

**MebelPlace Backend** - —ç—Ç–æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ Go-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω–æ–µ –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø–∞–º **Clean Architecture** —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º **Gin** —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞. –ü—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –¥–ª—è –º–µ–±–µ–ª—å–Ω–æ–≥–æ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞ —Å –≤–∏–¥–µ–æ-–∫–æ–Ω—Ç–µ–Ω—Ç–æ–º, –∑–∞—è–≤–∫–∞–º–∏ –º–∞—Å—Ç–µ—Ä–æ–≤ –∏ —Å–∏—Å—Ç–µ–º–æ–π –∑–∞–∫–∞–∑–æ–≤.

### –û—Å–Ω–æ–≤–Ω—ã–µ –¥–æ–º–µ–Ω—ã:
- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, –ø—Ä–æ—Ñ–∏–ª–∏
- **–í–∏–¥–µ–æ –∫–æ–Ω—Ç–µ–Ω—Ç** - –∑–∞–≥—Ä—É–∑–∫–∞, –ø—Ä–æ—Å–º–æ—Ç—Ä, –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ, AI –∞–Ω–∞–ª–∏–∑
- **–°–∏—Å—Ç–µ–º–∞ –∑–∞—è–≤–æ–∫** - —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–æ–∫, –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–∞—Å—Ç–µ—Ä–æ–≤, –ø—Ä–∏–Ω—è—Ç–∏–µ
- **–ß–∞—Ç –∏ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è** - –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ —á–∞—Ç—ã, –º–µ–¥–∏–∞ —Å–æ–æ–±—â–µ–Ω–∏—è, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- **–ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è** - –±–∞–ª–ª—ã, –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è, —É—Ä–æ–≤–Ω–∏
- **–°—Ç–æ—Ä–∏—Å—ã** - –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç (24 —á–∞—Å–∞)

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –í–µ—Ä—Å–∏—è |
|-----------|------------|--------|
| **–Ø–∑—ã–∫** | Go | 1.24 |
| **HTTP Framework** | Gin | 1.9.1 |
| **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** | PostgreSQL | 15-alpine |
| **–ö—ç—à** | Redis | 7-alpine |
| **–§–∞–π–ª–æ–≤–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ** | S3/MinIO | AWS SDK |
| **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** | JWT | RS256 |
| **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** | Prometheus + Grafana | 2.47.0 + 10.1.0 |
| **–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è** | Docker + Docker Compose | 3.8 |
| **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** | Zap | 1.26.0 |
| **Message Broker** | NATS + Kafka | 2.10 + 7.4.0 |
| **–¢—Ä–µ–π—Å–∏–Ω–≥** | Jaeger | 1.50 |

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
/opt/mebelplace/apps/backend/
‚îú‚îÄ‚îÄ cmd/                    # –¢–æ—á–∫–∏ –≤—Ö–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ api/               # –û—Å–Ω–æ–≤–Ω–æ–π API —Å–µ—Ä–≤–µ—Ä (main.go)
‚îÇ   ‚îú‚îÄ‚îÄ worker/            # –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
‚îÇ   ‚îú‚îÄ‚îÄ migrate/           # –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
‚îÇ   ‚îî‚îÄ‚îÄ cli/               # CLI —É—Ç–∏–ª–∏—Ç—ã
‚îú‚îÄ‚îÄ internal/              # –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ª–æ–≥–∏–∫–∞ (Clean Architecture)
‚îÇ   ‚îú‚îÄ‚îÄ domain/            # –î–æ–º–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ entities/      # User, Video, Request, Order, Proposal
‚îÇ   ‚îú‚îÄ‚îÄ http/              # HTTP handlers (v2 API)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ v2/            # 30+ –º–æ–¥—É–ª–µ–π –ø–æ –¥–æ–º–µ–Ω–∞–º
‚îÇ   ‚îú‚îÄ‚îÄ service/           # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (12 —Å–µ—Ä–≤–∏—Å–æ–≤)
‚îÇ   ‚îú‚îÄ‚îÄ database/          # –°–ª–æ–π –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ middleware/        # HTTP middleware (9 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤)
‚îÇ   ‚îú‚îÄ‚îÄ auth/              # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ cache/             # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (Redis)
‚îÇ   ‚îú‚îÄ‚îÄ events/            # Event Bus (Redis Pub/Sub)
‚îÇ   ‚îú‚îÄ‚îÄ health/            # Health checks
‚îÇ   ‚îú‚îÄ‚îÄ metrics/           # –ú–µ—Ç—Ä–∏–∫–∏ (Prometheus)
‚îÇ   ‚îú‚îÄ‚îÄ jobs/              # Background jobs
‚îÇ   ‚îî‚îÄ‚îÄ websocket/         # WebSocket
‚îú‚îÄ‚îÄ pkg/                   # –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–∞–∫–µ—Ç—ã
‚îú‚îÄ‚îÄ migrations/            # SQL –º–∏–≥—Ä–∞—Ü–∏–∏ (99+ —Ñ–∞–π–ª–æ–≤)
‚îú‚îÄ‚îÄ tests/                 # –¢–µ—Å—Ç—ã (unit, integration, e2e)
‚îú‚îÄ‚îÄ tools/                 # –£—Ç–∏–ª–∏—Ç—ã
‚îî‚îÄ‚îÄ deploy/                # Deployment –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```

---

## üéØ –î–æ–º–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏

### 1. **User** (`internal/domain/entities/user.go`)
```go
type User struct {
    ID           int        `json:"id" db:"id"`
    Email        string     `json:"email" db:"email"`
    Phone        string     `json:"phone" db:"phone"`
    Name         string     `json:"name" db:"name"`
    Nickname     string     `json:"nickname" db:"nickname"`
    Avatar       string     `json:"avatar" db:"avatar"`
    Description  string     `json:"description" db:"description"`
    Role         string     `json:"role" db:"role"` // client, master, admin
    Password     string     `json:"-" db:"password"`
    IsActive     bool       `json:"is_active" db:"is_active"`
    IsVerified   bool       `json:"is_verified" db:"is_verified"`
    CreatedAt    time.Time  `json:"created_at" db:"created_at"`
    UpdatedAt    time.Time  `json:"updated_at" db:"updated_at"`
    LastLoginAt  *time.Time `json:"last_login_at" db:"last_login_at"`
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –º–∞—Å—Ç–µ—Ä–æ–≤
    Experience      int     `json:"experience" db:"experience"`
    Rating          float64 `json:"rating" db:"rating"`
    ReviewCount     int     `json:"review_count" db:"review_count"`
    CompletedOrders int     `json:"completed_orders" db:"completed_orders"`
}
```

**–ú–µ—Ç–æ–¥—ã:**
- `IsMaster()`, `IsClient()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏
- `UpdateLastLogin()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—Ö–æ–¥–∞
- `VerifyEmail()` - –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email
- `UpdateProfile()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
- `UpdateMasterStats()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–∞—Å—Ç–µ—Ä–∞

### 2. **Video** (`internal/domain/entities/video.go`)
```go
type Video struct {
    ID                 int       `json:"id" db:"id"`
    UserID             int       `json:"user_id" db:"user_id"`
    Title              string    `json:"title" db:"title"`
    Description        string    `json:"description" db:"description"`
    Path               string    `json:"path" db:"path"`
    ThumbnailPath      string    `json:"thumbnail_path" db:"thumbnail_path"`
    SizeBytes          int64     `json:"size_bytes" db:"size_bytes"`
    Duration           int       `json:"duration" db:"duration"`
    Hashtags           []string  `json:"hashtags" db:"hashtags"`
    IsProduct          bool      `json:"is_product" db:"is_product"`
    ProductPrice       *float64  `json:"product_price" db:"product_price"`
    ProductDescription *string   `json:"product_description" db:"product_description"`
    Views              int       `json:"views" db:"views"`
    Likes              int       `json:"likes" db:"likes"`
    Comments           int       `json:"comments" db:"comments"`
    Shares             int       `json:"shares" db:"shares"`
    IsActive           bool      `json:"is_active" db:"is_active"`
    CreatedAt          time.Time `json:"created_at" db:"created_at"`
    UpdatedAt          time.Time `json:"updated_at" db:"updated_at"`
}
```

**–ú–µ—Ç–æ–¥—ã:**
- `AddLike()`, `RemoveLike()` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∞–π–∫–∞–º–∏
- `AddView()` - —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
- `SetProductInfo()` - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ–¥—É–∫—Ç–µ
- `ValidateUpload()` - –≤–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
- `GetFormattedDuration()` - —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### 3. **Request** (`internal/domain/entities/request.go`)
```go
type Request struct {
    ID          int        `json:"id" db:"id"`
    UserID      int        `json:"user_id" db:"user_id"`
    Title       string     `json:"title" db:"title"`
    Description string     `json:"description" db:"description"`
    Budget      *float64   `json:"budget" db:"budget"`
    Region      string     `json:"region" db:"region"`
    Images      []string   `json:"images" db:"images"`
    Status      string     `json:"status" db:"status"`
    Views       int        `json:"views" db:"views"`
    Responses   int        `json:"responses" db:"responses"`
    CreatedAt   time.Time  `json:"created_at" db:"created_at"`
    UpdatedAt   time.Time  `json:"updated_at" db:"updated_at"`
    ExpiresAt   *time.Time `json:"expires_at" db:"expires_at"`
}
```

**–ú–µ—Ç–æ–¥—ã:**
- `IsActive()`, `IsExpired()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
- `ExtendExpiration()` - –ø—Ä–æ–¥–ª–µ–Ω–∏–µ —Å—Ä–æ–∫–∞
- `Close()`, `Reopen()` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–º
- `GetFormattedBudget()` - —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±—é–¥–∂–µ—Ç

### 4. **Order** (`internal/domain/entities/order.go`)
```go
type Order struct {
    ID            int        `json:"id" db:"id"`
    RequestID     int        `json:"request_id" db:"request_id"`
    ClientID      int        `json:"client_id" db:"client_id"`
    MasterID      int        `json:"master_id" db:"master_id"`
    ProductName   string     `json:"product_name" db:"product_name"`
    Description   string     `json:"description" db:"description"`
    Price         float64    `json:"price" db:"price"`
    Status        string     `json:"status" db:"status"`
    DeliveryDate  *time.Time `json:"delivery_date" db:"delivery_date"`
    Comment       string     `json:"comment" db:"comment"`
    RevisionNotes string     `json:"revision_notes" db:"revision_notes"`
    CreatedAt     time.Time  `json:"created_at" db:"created_at"`
    UpdatedAt     time.Time  `json:"updated_at" db:"updated_at"`
    CompletedAt   *time.Time `json:"completed_at" db:"completed_at"`
}
```

**–°—Ç–∞—Ç—É—Å—ã:** pending ‚Üí accepted ‚Üí in_progress ‚Üí completed/cancelled/revision

### 5. **Proposal** (`internal/domain/entities/proposal.go`)
```go
type Proposal struct {
    ID            int        `json:"id" db:"id"`
    RequestID     int        `json:"request_id" db:"request_id"`
    MasterID      int        `json:"master_id" db:"master_id"`
    Price         float64    `json:"price" db:"price"`
    Message       string     `json:"message" db:"message"`
    EstimatedDays int        `json:"estimated_days" db:"estimated_days"`
    Status        string     `json:"status" db:"status"`
    CreatedAt     time.Time  `json:"created_at" db:"created_at"`
    UpdatedAt     time.Time  `json:"updated_at" db:"updated_at"`
    AcceptedAt    *time.Time `json:"accepted_at" db:"accepted_at"`
}
```

---

## üöÄ API Endpoints

### **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** (`/api/v2/auth/`)
```go
POST /register     - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å SMS/Email –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
POST /login        - –í—Ö–æ–¥ –ø–æ email/—Ç–µ–ª–µ—Ñ–æ–Ω—É
POST /verify-sms   - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ SMS –∫–æ–¥–∞
POST /verify-email - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ Email –∫–æ–¥–∞
POST /refresh      - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
POST /logout       - –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
```

**–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:**
```json
{
  "email_or_phone": "user@example.com",
  "password": "password123",
  "username": "username",
  "role": "buyer"
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "access_token": "jwt_token",
  "refresh_token": "refresh_token",
  "expires_in": 3600,
  "user": {
    "id": 1,
    "username": "username",
    "email": "user@example.com",
    "role": "buyer"
  }
}
```

### **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏** (`/api/v2/users/`)
```go
GET  /me           - –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
GET  /:id          - –ü—É–±–ª–∏—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å
PUT  /me           - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
POST /me/avatar    - –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞
POST /:id/block    - –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```

### **–í–∏–¥–µ–æ** (`/api/v2/videos/`)
```go
GET  /feed         - –õ–µ–Ω—Ç–∞ –≤–∏–¥–µ–æ (–ø–∞–≥–∏–Ω–∞—Ü–∏—è)
GET  /:id          - –î–µ—Ç–∞–ª–∏ –≤–∏–¥–µ–æ
POST /upload       - –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ + –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
POST /:id/like     - –õ–∞–π–∫ –≤–∏–¥–µ–æ
POST /:id/unlike   - –£–±—Ä–∞—Ç—å –ª–∞–π–∫
POST /:id/comments - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
GET  /:id/comments - –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
POST /:id/analyze  - AI –∞–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ
```

**–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ:**
```go
// Multipart form data
video: file          // –í–∏–¥–µ–æ —Ñ–∞–π–ª (–¥–æ 300MB)
thumbnail: file      // –ü—Ä–µ–≤—å—é (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
title: string        // –ó–∞–≥–æ–ª–æ–≤–æ–∫
description: string  // –û–ø–∏—Å–∞–Ω–∏–µ
hashtags: string     // "#–º–µ–±–µ–ª—å #—à–∫–∞—Ñ"
price: float         // –¶–µ–Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
product_description: string
is_ad: boolean
```

**AI –∞–Ω–∞–ª–∏–∑:**
```json
{
  "analysis_type": "furniture|scene|objects|text|sentiment",
  "options": {
    "confidence_threshold": 0.8
  }
}
```

### **–ó–∞—è–≤–∫–∏** (`/api/v2/requests/`)
```go
GET  /             - –°–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫ (—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–æ–ª–∏)
GET  /:id          - –î–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏
POST /             - –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ (–∫–ª–∏–µ–Ω—Ç—ã)
POST /:id/proposals - –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–∞
GET  /:id/proposals - –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
POST /:id/proposals/:proposal_id/accept - –ü—Ä–∏–Ω—è—Ç–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
```

**–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏:**
```json
{
  "title": "–ù—É–∂–µ–Ω —à–∫–∞—Ñ-–∫—É–ø–µ",
  "description": "–û–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π",
  "region": "–ê–ª–º–∞—Ç—ã",
  "categories": ["–º–µ–±–µ–ª—å", "—à–∫–∞—Ñ—ã"]
}
```

**–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–∞:**
```json
{
  "price": 150000,
  "deadline_days": 14,
  "message": "–ú–æ–≥—É –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–∫–∞–∑"
}
```

### **–ß–∞—Ç** (`/api/v2/chats/`)
```go
GET  /             - –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
POST /             - –°–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞
GET  /:id/messages - –°–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞
POST /:id/messages - –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è (—Ç–µ–∫—Å—Ç/–º–µ–¥–∏–∞)
```

**–°–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞:**
```json
{
  "request_id": 123,
  "recipient_id": 456,
  "initial_message": "–ü—Ä–∏–≤–µ—Ç!"
}
```

**–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:**
```json
// –¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
{
  "content": "–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è",
  "type": "text"
}

// –ú–µ–¥–∏–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ (multipart/form-data)
file: file
type: "image|voice|video|file"
```

### **–ü–æ–¥–ø–∏—Å–∫–∏** (`/api/v2/subscriptions/`)
```go
POST /:user_id     - –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
DELETE /:user_id   - –û—Ç–ø–∏—Å–∫–∞
GET  /my           - –ú–æ–∏ –ø–æ–¥–ø–∏—Å–∫–∏
```

### **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** (`/api/v2/notifications/`)
```go
GET  /             - –°–ø–∏—Å–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
POST /:id/read     - –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
POST /read-all     - –û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
GET  /settings     - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
POST /settings     - –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
POST /push-token   - –û–±–Ω–æ–≤–∏—Ç—å push —Ç–æ–∫–µ–Ω
```

### **–ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è** (`/api/v2/gamification/`)
```go
GET  /level                    - –£—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
GET  /achievements            - –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
GET  /leaderboard             - –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤
POST /award-points            - –ù–∞—á–∏—Å–ª–∏—Ç—å –æ—á–∫–∏
GET  /leaderboard/advanced    - –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞
GET  /levels                  - –í—Å–µ —É—Ä–æ–≤–Ω–∏
GET  /achievements/user/:id   - –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```

### **–ó–≤–æ–Ω–∫–∏** (`/api/v2/calls/`)
```go
GET  /                        - –°–ø–∏—Å–æ–∫ –∑–≤–æ–Ω–∫–æ–≤
POST /initiate                - –ò–Ω–∏—Ü–∏–∞—Ü–∏—è –∑–≤–æ–Ω–∫–∞
POST /initiate-secure         - –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∑–≤–æ–Ω–æ–∫
POST /:id/answer              - –û—Ç–≤–µ—Ç –Ω–∞ –∑–≤–æ–Ω–æ–∫
POST /:id/end                 - –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞
POST /:id/cancel              - –û—Ç–º–µ–Ω–∞ –∑–≤–æ–Ω–∫–∞
GET  /history                 - –ò—Å—Ç–æ—Ä–∏—è –∑–≤–æ–Ω–∫–æ–≤
GET  /active                  - –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–≤–æ–Ω–∫–∏
GET  /:id/webrtc-token        - WebRTC —Ç–æ–∫–µ–Ω
POST /:id/webrtc-signal       - WebRTC —Å–∏–≥–Ω–∞–ª
```

### **–°—Ç–æ—Ä–∏—Å—ã** (`/api/v2/stories/`)
```go
POST /             - –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–æ—Ä–∏—Å–∞
GET  /             - –°–ø–∏—Å–æ–∫ —Å—Ç–æ—Ä–∏—Å–æ–≤
GET  /:id          - –î–µ—Ç–∞–ª–∏ —Å—Ç–æ—Ä–∏—Å–∞
POST /:id/view     - –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–æ—Ä–∏—Å–∞
POST /:id/like     - –õ–∞–π–∫ —Å—Ç–æ—Ä–∏—Å–∞
```

### **–ü–æ–∏—Å–∫** (`/api/v2/search/`)
```go
GET  /             - –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫
GET  /users        - –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
GET  /masters      - –ü–æ–∏—Å–∫ –º–∞—Å—Ç–µ—Ä–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ –ª–æ–∫–∞—Ü–∏–∏
```

### **–ê–¥–º–∏–Ω–∫–∞** (`/api/v2/admin/`)
```go
GET  /users                    - –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
POST /users/:id/ban           - –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
POST /users/:id/unban         - –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
PUT  /users/:id/role          - –ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å
POST /users/:id/suspend       - –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
GET  /support/tickets         - –í—Å–µ —Ç–∏–∫–µ—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏
PATCH /support/tickets/:id    - –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Ç–∏–∫–µ—Ç–∞
POST /support/tickets/:id/replies - –û—Ç–≤–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
```

---

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### **–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã**

#### **users** - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
```sql
CREATE TABLE users (
  id              BIGSERIAL PRIMARY KEY,
  email           TEXT UNIQUE,
  phone           TEXT UNIQUE,
  username        TEXT UNIQUE,
  phone_verified  BOOLEAN NOT NULL DEFAULT FALSE,
  email_verified  BOOLEAN NOT NULL DEFAULT FALSE,
  name            TEXT NOT NULL DEFAULT '',
  password_hash   TEXT NOT NULL,
  role            TEXT NOT NULL DEFAULT 'buyer', -- admin, master, buyer
  avatar          TEXT,
  region          TEXT,
  description     TEXT,
  is_active       BOOLEAN DEFAULT TRUE,
  created_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at      TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

#### **videos** - –í–∏–¥–µ–æ
```sql
CREATE TABLE videos (
  id                 BIGSERIAL PRIMARY KEY,
  user_id           BIGINT REFERENCES users(id) ON DELETE CASCADE,
  title             TEXT NOT NULL,
  description       TEXT DEFAULT '',
  path              TEXT NOT NULL,
  thumbnail_path    TEXT,
  size_bytes        BIGINT NOT NULL DEFAULT 0,
  duration          INTEGER DEFAULT 0,
  hashtags          TEXT[] NOT NULL DEFAULT '{}',
  is_product        BOOLEAN DEFAULT FALSE,
  product_price     DECIMAL(10,2),
  product_description TEXT,
  views_count       INTEGER DEFAULT 0,
  likes_count       INTEGER DEFAULT 0,
  comments_count    INTEGER DEFAULT 0,
  shares_count      INTEGER DEFAULT 0,
  is_ad             BOOLEAN DEFAULT FALSE,
  created_at        TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at        TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

#### **requests** - –ó–∞—è–≤–∫–∏
```sql
CREATE TABLE requests (
  id          BIGSERIAL PRIMARY KEY,
  user_id     BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  assignee_id BIGINT REFERENCES users(id) ON DELETE SET NULL,
  title       TEXT NOT NULL,
  description TEXT NOT NULL DEFAULT '',
  region_code TEXT REFERENCES regions(code) ON DELETE RESTRICT,
  budget      DECIMAL(10,2),
  status      TEXT NOT NULL DEFAULT 'pending',
  created_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at  TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

#### **request_proposals** - –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–∞—Å—Ç–µ—Ä–æ–≤
```sql
CREATE TABLE request_proposals (
  id           BIGSERIAL PRIMARY KEY,
  request_id   BIGINT NOT NULL REFERENCES requests(id) ON DELETE CASCADE,
  master_id    BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  price_cents  BIGINT NOT NULL,
  deadline_days INTEGER,
  message      TEXT,
  status       TEXT NOT NULL DEFAULT 'pending',
  created_at   TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at   TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

#### **master_orders** - –ó–∞–∫–∞–∑—ã
```sql
CREATE TABLE master_orders (
  id            BIGSERIAL PRIMARY KEY,
  request_id    BIGINT NOT NULL REFERENCES requests(id),
  proposal_id   BIGINT NOT NULL REFERENCES request_proposals(id),
  client_id     BIGINT NOT NULL REFERENCES users(id),
  master_id     BIGINT NOT NULL REFERENCES users(id),
  budget_cents  BIGINT NOT NULL,
  deadline_days INTEGER,
  status        TEXT NOT NULL DEFAULT 'pending',
  created_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at    TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

#### **chats** - –ß–∞—Ç—ã
```sql
CREATE TABLE chats (
  id         BIGSERIAL PRIMARY KEY,
  request_id BIGINT REFERENCES requests(id),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE messages (
  id           BIGSERIAL PRIMARY KEY,
  chat_id      BIGINT NOT NULL REFERENCES chats(id) ON DELETE CASCADE,
  sender_id    BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  content      TEXT NOT NULL,
  message_type TEXT NOT NULL DEFAULT 'text', -- text, image, voice, video, file
  is_read      BOOLEAN DEFAULT FALSE,
  created_at   TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE chat_participants (
  chat_id BIGINT NOT NULL REFERENCES chats(id) ON DELETE CASCADE,
  user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  PRIMARY KEY (chat_id, user_id)
);
```

#### **stories** - –°—Ç–æ—Ä–∏—Å—ã
```sql
CREATE TABLE stories (
  id                BIGSERIAL PRIMARY KEY,
  user_id           BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  media_url         VARCHAR(500) NOT NULL,
  media_type        VARCHAR(20) NOT NULL CHECK (media_type IN ('image', 'video', 'voice')),
  duration_seconds  INTEGER DEFAULT 5,
  thumbnail_url     VARCHAR(500),
  caption           TEXT,
  background_color  VARCHAR(20),
  music_url         VARCHAR(500),
  hashtags          TEXT[],
  location          VARCHAR(255),
  views_count       INTEGER DEFAULT 0,
  likes_count       INTEGER DEFAULT 0,
  is_pinned         BOOLEAN DEFAULT false,
  expires_at        TIMESTAMPTZ DEFAULT (NOW() + INTERVAL '24 hours'),
  is_expired        BOOLEAN DEFAULT false,
  created_at        TIMESTAMPTZ DEFAULT NOW()
);
```

#### **user_points** - –ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è
```sql
CREATE TABLE user_points (
  id          SERIAL PRIMARY KEY,
  user_id     BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  points      INTEGER NOT NULL DEFAULT 0,
  type        VARCHAR(50) NOT NULL, -- 'request', 'order_completed', 'like_received', 'subscriber', 'comment'
  description TEXT,
  created_at  TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE achievements (
  id          VARCHAR(50) PRIMARY KEY,
  name        VARCHAR(100) NOT NULL,
  description TEXT NOT NULL,
  icon        VARCHAR(100),
  points      INTEGER NOT NULL DEFAULT 0,
  created_at  TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE user_achievements (
  id            SERIAL PRIMARY KEY,
  user_id       BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  achievement_id VARCHAR(50) NOT NULL REFERENCES achievements(id) ON DELETE CASCADE,
  unlocked_at   TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id, achievement_id)
);
```

### **–ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
```sql
-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
CREATE INDEX idx_users_lower_email ON users((lower(email)));
CREATE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_created_at ON users(created_at DESC);
CREATE INDEX idx_users_role ON users(role);

-- –í–∏–¥–µ–æ
CREATE INDEX videos_created_at_idx ON videos (created_at DESC);
CREATE INDEX videos_hashtags_gin ON videos USING gin (hashtags);
CREATE INDEX idx_videos_user_id ON videos(user_id);
CREATE INDEX idx_videos_is_product ON videos(is_product);

-- –ó–∞—è–≤–∫–∏
CREATE INDEX idx_requests_user ON requests(user_id, created_at DESC);
CREATE INDEX idx_requests_assignee ON requests(assignee_id, status, created_at DESC);
CREATE INDEX idx_requests_status ON requests(status, created_at DESC);
CREATE INDEX idx_requests_region ON requests(region_code);

-- –°—Ç–æ—Ä–∏—Å—ã
CREATE INDEX idx_stories_user_id ON stories(user_id);
CREATE INDEX idx_stories_created_at ON stories(created_at DESC);
CREATE INDEX idx_stories_expires_at ON stories(expires_at);
CREATE INDEX idx_stories_is_expired ON stories(is_expired);
```

### **–¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏**
```sql
-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –æ—á–∫–æ–≤ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏
CREATE OR REPLACE FUNCTION award_points_for_request()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO user_points (user_id, points, type, description)
    VALUES (NEW.user_id, 10, 'request', '–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏: ' || NEW.title);
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_award_points_for_request
    AFTER INSERT ON requests
    FOR EACH ROW
    EXECUTE FUNCTION award_points_for_request();

-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –æ—á–∫–æ–≤ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ª–∞–π–∫–∞
CREATE OR REPLACE FUNCTION award_points_for_like()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO user_points (user_id, points, type, description)
    SELECT v.user_id, 5, 'like_received', '–ü–æ–ª—É—á–µ–Ω –ª–∞–π–∫ –∑–∞ –≤–∏–¥–µ–æ: ' || v.title
    FROM videos v WHERE v.id = NEW.video_id;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_award_points_for_like
    AFTER INSERT ON video_likes
    FOR EACH ROW
    EXECUTE FUNCTION award_points_for_like();
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ Middleware

### **JWT –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** (`internal/middleware/jwt_auth.go`)
```go
func JWTAuthMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        authHeader := c.GetHeader("Authorization")
        if authHeader == "" {
            c.JSON(http.StatusUnauthorized, gin.H{"error": "Authorization header required"})
            c.Abort()
            return
        }

        parts := strings.Split(authHeader, " ")
        if len(parts) != 2 || parts[0] != "Bearer" {
            c.JSON(http.StatusUnauthorized, gin.H{"error": "Invalid Authorization header format"})
            c.Abort()
            return
        }

        tokenString := parts[1]
        claims, err := auth.ValidateAccessToken(tokenString)
        if err != nil {
            c.JSON(http.StatusUnauthorized, gin.H{"error": "Invalid or expired token"})
            c.Abort()
            return
        }

        c.Set("user_id", claims.UserID)
        c.Set("role", claims.Role)
        c.Next()
    }
}
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- **RS256 –∞–ª–≥–æ—Ä–∏—Ç–º** —Å –ø—Ä–∏–≤–∞—Ç–Ω—ã–º/–ø—É–±–ª–∏—á–Ω—ã–º –∫–ª—é—á–∞–º–∏
- **Access —Ç–æ–∫–µ–Ω—ã**: 15 –º–∏–Ω—É—Ç –∂–∏–∑–Ω–∏
- **Refresh —Ç–æ–∫–µ–Ω—ã**: 30 –¥–Ω–µ–π —Å —Ä–æ—Ç–∞—Ü–∏–µ–π
- **HttpOnly cookies** + Authorization header

### **Rate Limiting** (`internal/middleware/ratelimit.go`)
```go
type RateLimiter struct {
    requests map[string]*ClientRequests
    mu       sync.RWMutex
    limit    int
    window   time.Duration
}

func APIRateLimitMiddleware() gin.HandlerFunc {
    limiter := NewRateLimiter(5000, 1*time.Minute) // 5000 req/min
    return limiter.RateLimitMiddleware()
}

func StrictRateLimitMiddleware() gin.HandlerFunc {
    limiter := NewRateLimiter(100, 1*time.Minute) // 100 req/min
    return limiter.RateLimitMiddleware()
}
```

**–õ–∏–º–∏—Ç—ã:**
- **API endpoints**: 5000 RPS, burst 200
- **–°—Ç—Ä–æ–≥–∏–µ endpoints**: 100 RPS
- **DDoS –∑–∞—â–∏—Ç–∞**: 100 req/min —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π User-Agent
- **–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤**: –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ª–∏–º–∏—Ç—ã

### **Security Headers** (`internal/middleware/security.go`)
```go
func SecurityHeadersMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        c.Header("X-Frame-Options", "DENY")
        c.Header("X-Content-Type-Options", "nosniff")
        c.Header("X-XSS-Protection", "1; mode=block")
        c.Header("Strict-Transport-Security", "max-age=31536000; includeSubDomains; preload")
        c.Header("Content-Security-Policy", "default-src 'self'; script-src 'self' 'unsafe-inline'...")
        c.Header("Referrer-Policy", "strict-origin-when-cross-origin")
        c.Header("Permissions-Policy", "geolocation=(), microphone=(), camera=()")
        c.Next()
    }
}
```

### **Input Sanitization**
```go
func InputSanitizationMiddleware() gin.HandlerFunc {
    sqlInjectionPatterns := []*regexp.Regexp{
        regexp.MustCompile(`(?i)(union\s+select|drop\s+table|insert\s+into)`),
        regexp.MustCompile(`(?i)(--|#|\/\*|\*\/|xp_|sp_)`),
    }
    
    xssPatterns := []*regexp.Regexp{
        regexp.MustCompile(`(?i)<script[^>]*>.*?</script>`),
        regexp.MustCompile(`(?i)javascript:`),
        regexp.MustCompile(`(?i)on\w+\s*=`),
    }
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ query –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –Ω–∞ SQL injection –∏ XSS
}
```

### **CSRF Protection**
```go
func CSRFProtectionMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        if c.Request.Method == "GET" || c.Request.Method == "HEAD" || c.Request.Method == "OPTIONS" {
            c.Next()
            return
        }

        origin := c.GetHeader("Origin")
        referer := c.GetHeader("Referer")
        
        allowedOrigins := []string{
            "https://mebelplace.com.kz",
            "https://www.mebelplace.com.kz",
            "http://localhost:3000",
        }
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ Origin/Referer
    }
}
```

### **Password Validation**
```go
func ValidatePasswordStrength(password string) error {
    if len(password) < 8 {
        return errors.New("–ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤")
    }
    
    hasUpper := regexp.MustCompile(`[A-Z]`).MatchString(password)
    hasLower := regexp.MustCompile(`[a-z]`).MatchString(password)
    hasNumber := regexp.MustCompile(`[0-9]`).MatchString(password)
    hasSpecial := regexp.MustCompile(`[!@#$%^&*(),.?":{}|<>_+\-=\[\]\\|;':",./<>?]`).MatchString(password)
    
    strength := 0
    if hasUpper { strength++ }
    if hasLower { strength++ }
    if hasNumber { strength++ }
    if hasSpecial { strength++ }
    
    if strength < 2 {
        return errors.New("–ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 –∏–∑: –∑–∞–≥–ª–∞–≤–Ω—ã–µ –±—É–∫–≤—ã, —Å—Ç—Ä–æ—á–Ω—ã–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã")
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–æ—Å—Ç—ã–µ –ø–∞—Ä–æ–ª–∏
    veryCommonPasswords := []string{"123456", "password", "qwerty", "admin", ...}
    // ...
}
```

### **Structured Logging** (`internal/middleware/logging.go`)
```go
func LoggingMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        start := time.Now()
        path := c.Request.URL.Path
        method := c.Request.Method

        c.Next()

        latency := time.Since(start)
        status := c.Writer.Status()
        ctx := c.Request.Context()

        fields := []zap.Field{
            zap.String("method", method),
            zap.String("path", path),
            zap.Int("status", status),
            zap.Duration("latency", latency),
            zap.String("ip", c.ClientIP()),
            zap.String("user_agent", c.Request.UserAgent()),
        }

        if userID, exists := c.Get("user_id"); exists {
            fields = append(fields, zap.Any("user_id", userID))
        }

        if status >= 500 {
            log.Error(ctx, "HTTP request error", nil, fields...)
        } else if status >= 400 {
            log.Warn(ctx, "HTTP request client error", fields...)
        } else {
            log.Info(ctx, "HTTP request", fields...)
        }
    }
}
```

---

## üèóÔ∏è –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

### **Docker Compose Stack**
```yaml
version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: mebelplace-postgres
    environment:
      POSTGRES_DB: mebelplace
      POSTGRES_USER: mebelplace
      POSTGRES_PASSWORD: mebelplace123
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mebelplace -d mebelplace"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: mebelplace-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # NATS Message Broker
  nats:
    image: nats:2.10-alpine
    container_name: mebelplace-nats
    ports:
      - "4222:4222"
      - "8222:8222"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8222/healthz"]

  # Kafka Message Broker
  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: mebelplace-kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1

  # Jaeger Tracing
  jaeger:
    image: jaegertracing/all-in-one:1.50
    container_name: mebelplace-jaeger
    ports:
      - "16686:16686"
      - "14268:14268"
    environment:
      COLLECTOR_OTLP_ENABLED: true

  # Prometheus Metrics
  prometheus:
    image: prom/prometheus:v2.47.0
    container_name: mebelplace-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus

  # Grafana Dashboard
  grafana:
    image: grafana/grafana:10.1.0
    container_name: mebelplace-grafana
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin123
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards

  # MebelPlace API
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mebelplace-api
    ports:
      - "8080:8080"
    environment:
      DATABASE_URL: postgres://mebelplace:mebelplace123@postgres:5432/mebelplace?sslmode=disable
      REDIS_URL: redis://redis:6379
      NATS_URL: nats://nats:4222
      KAFKA_BROKERS: kafka:9092
      JAEGER_ENDPOINT: http://jaeger:14268/api/traces
      LOG_LEVEL: info
      ENVIRONMENT: development
      PORT: 8080
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
```

### **Dockerfile**
```dockerfile
FROM golang:1.24-alpine AS builder

WORKDIR /build

COPY go.mod go.sum ./
RUN go mod download

COPY . .

RUN CGO_ENABLED=0 GOOS=linux go build -o api ./cmd/api

FROM alpine:latest

RUN apk --no-cache add ca-certificates openssl ffmpeg

WORKDIR /app

COPY --from=builder /build/api .

# Copy JWT keys
COPY jwt-keys/ /app/jwt-keys/

EXPOSE 8080

CMD ["./api"]
```

### **Health Checks** (`internal/health/health.go`)
```go
type SystemHealth struct {
    OverallStatus string                 `json:"overall_status"`
    Service       string                 `json:"service"`
    Version       string                 `json:"version"`
    Timestamp     time.Time              `json:"timestamp"`
    Components    map[string]interface{} `json:"components"`
}

func SetupRoutes(router *gin.Engine) {
    router.GET("/health", GetGlobalHealth().HealthHandler())
    router.GET("/live", LivenessHandler())
    router.GET("/ready", ReadinessHandler())
}
```

**Endpoints:**
- `/health` - –æ–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
- `/live` - liveness probe –¥–ª—è Kubernetes
- `/ready` - readiness probe –¥–ª—è Kubernetes

---

## üíæ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

### **Redis Cache System** (`internal/cache/redis.go`)

#### **Feed Cache** (TTL 3 –º–∏–Ω—É—Ç—ã)
```go
func GetFeedCache(ctx context.Context, userID int64, limit, offset int) (string, error) {
    key := fmt.Sprintf("feed:%d:%d:%d", userID, limit, offset)
    return client.Get(ctx, key).Result()
}

func SetFeedCache(ctx context.Context, userID int64, limit, offset int, data interface{}) error {
    key := fmt.Sprintf("feed:%d:%d:%d", userID, limit, offset)
    jsonData, err := json.Marshal(data)
    if err != nil {
        return err
    }
    return client.Set(ctx, key, jsonData, 3*time.Minute).Err()
}
```

#### **Video Cache** (TTL 15 –º–∏–Ω—É—Ç)
```go
func GetVideoCache(ctx context.Context, videoID int64) (string, error) {
    key := fmt.Sprintf("video:%d", videoID)
    return client.Get(ctx, key).Result()
}

func SetVideoCache(ctx context.Context, videoID int64, data interface{}) error {
    key := fmt.Sprintf("video:%d", videoID)
    jsonData, err := json.Marshal(data)
    if err != nil {
        return err
    }
    return client.Set(ctx, key, jsonData, 15*time.Minute).Err()
}
```

#### **User Profile Cache** (TTL 10 –º–∏–Ω—É—Ç)
```go
func GetUserProfileCache(ctx context.Context, userID int64) (string, error) {
    key := fmt.Sprintf("user:profile:%d", userID)
    return client.Get(ctx, key).Result()
}

func SetUserProfileCache(ctx context.Context, userID int64, data interface{}) error {
    key := fmt.Sprintf("user:profile:%d", userID)
    jsonData, err := json.Marshal(data)
    if err != nil {
        return err
    }
    return client.Set(ctx, key, jsonData, 10*time.Minute).Err()
}
```

#### **Views Counter** (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π flush)
```go
func IncrementViewsCounter(ctx context.Context, videoID int64) error {
    key := fmt.Sprintf("video:views:pending:%d", videoID)
    return client.Incr(ctx, key).Err()
}

func GetAndResetViewsCounter(ctx context.Context, videoID int64) (int64, error) {
    key := fmt.Sprintf("video:views:pending:%d", videoID)
    
    script := redis.NewScript(`
        local val = redis.call('GET', KEYS[1])
        redis.call('DEL', KEYS[1])
        return val
    `)

    result, err := script.Run(ctx, client, []string{key}).Result()
    // ...
}
```

#### **Distributed Locks**
```go
func AcquireLock(ctx context.Context, lockKey string, ttl time.Duration) (bool, error) {
    key := fmt.Sprintf("locks:%s", lockKey)
    return client.SetNX(ctx, key, "1", ttl).Result()
}

func ReleaseLock(ctx context.Context, lockKey string) error {
    key := fmt.Sprintf("locks:%s", lockKey)
    return client.Del(ctx, key).Err()
}
```

#### **WebSocket Presence**
```go
func SetUserPresence(ctx context.Context, userID int64) error {
    key := fmt.Sprintf("ws:presence:%d", userID)
    return client.Set(ctx, key, "online", 1*time.Minute).Err()
}

func GetUserPresence(ctx context.Context, userID int64) (bool, error) {
    key := fmt.Sprintf("ws:presence:%d", userID)
    _, err := client.Get(ctx, key).Result()
    if err == redis.Nil {
        return false, nil
    }
    return err == nil, err
}
```

---

## üì° Event System

### **Event Bus Interface** (`internal/events/event.go`)
```go
type Event struct {
    ID        string                 `json:"id"`
    Type      string                 `json:"type"`
    Payload   map[string]interface{} `json:"payload"`
    Timestamp time.Time              `json:"timestamp"`
    Version   string                 `json:"version"`
}

type EventHandler func(ctx context.Context, event Event) error

type EventBus interface {
    Publish(ctx context.Context, event Event) error
    Subscribe(ctx context.Context, eventType string, handler EventHandler) error
    Close() error
}
```

### **–¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π**
```go
const (
    EventVideoUploaded  = "video.uploaded"  // ‚Üí thumbnail job
    EventVideoViewed    = "video.viewed"    // ‚Üí analytics
    EventVideoLiked     = "video.liked"     // ‚Üí notifications
    EventVideoCommented = "video.commented" // ‚Üí notifications

    EventRequestCreated = "request.created" // ‚Üí push to masters
    EventRequestUpdated = "request.updated" // ‚Üí notifications

    EventChatMessage = "chat.message" // ‚Üí notifications
    EventChatTyping  = "chat.typing"  // ‚Üí websocket broadcast

    EventUserRegistered = "user.registered" // ‚Üí welcome email/sms
    EventUserUpdated    = "user.updated"    // ‚Üí cache invalidation
)
```

### **Redis Event Bus** (`internal/events/redis_bus.go`)
```go
type RedisBus struct {
    client    *redis.Client
    pubsub    *redis.PubSub
    handlers  map[string][]EventHandler
    mu        sync.RWMutex
    ctx       context.Context
    cancel    context.CancelFunc
    waitGroup sync.WaitGroup
}

func (b *RedisBus) Publish(ctx context.Context, event Event) error {
    if event.ID == "" {
        event.ID = uuid.New().String()
    }
    if event.Timestamp.IsZero() {
        event.Timestamp = time.Now()
    }
    if event.Version == "" {
        event.Version = "1.0"
    }

    data, err := json.Marshal(event)
    if err != nil {
        return fmt.Errorf("failed to marshal event: %w", err)
    }

    channel := fmt.Sprintf("events:%s", event.Type)
    err = b.client.Publish(ctx, channel, data).Err()
    if err != nil {
        log.Error(ctx, "Failed to publish event to Redis", err, 
            zap.String("event_type", event.Type), 
            zap.String("event_id", event.ID))
        return fmt.Errorf("failed to publish event: %w", err)
    }

    return nil
}

func (b *RedisBus) Subscribe(ctx context.Context, eventType string, handler EventHandler) error {
    b.mu.Lock()
    b.handlers[eventType] = append(b.handlers[eventType], handler)
    isFirstHandler := len(b.handlers[eventType]) == 1
    b.mu.Unlock()

    if isFirstHandler {
        channel := fmt.Sprintf("events:%s", eventType)
        
        if b.pubsub == nil {
            b.pubsub = b.client.Subscribe(ctx, channel)
        } else {
            b.pubsub.Subscribe(ctx, channel)
        }

        b.waitGroup.Add(1)
        go b.listenToChannel(eventType)
    }

    return nil
}
```

### **Event Handlers –≤ main.go**
```go
func setupEventHandlers(bus events.EventBus) {
    ctx := context.Background()

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ video.uploaded ‚Üí thumbnail generation
    if err := bus.Subscribe(ctx, events.EventVideoUploaded, func(ctx context.Context, event events.Event) error {
        videoID, ok := event.Payload["video_id"].(float64)
        if !ok {
            return fmt.Errorf("invalid video_id in event")
        }
        log.Info(ctx, "Video uploaded event received", zap.Float64("video_id", videoID))
        // Thumbnail generation handled by ffmpeg worker
        return nil
    }); err != nil {
        log.Error(ctx, "Failed to subscribe to video.uploaded", err)
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ request.created ‚Üí push to masters
    if err := bus.Subscribe(ctx, events.EventRequestCreated, func(ctx context.Context, event events.Event) error {
        requestID, ok := event.Payload["request_id"].(float64)
        if !ok {
            return fmt.Errorf("invalid request_id in event")
        }
        log.Info(ctx, "Request created event received", zap.Float64("request_id", requestID))
        // Push notifications sent by request handler directly
        return nil
    }); err != nil {
        log.Error(ctx, "Failed to subscribe to request.created", err)
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ chat.message ‚Üí notifications
    if err := bus.Subscribe(ctx, events.EventChatMessage, func(ctx context.Context, event events.Event) error {
        log.Info(ctx, "Chat message event received", zap.Any("payload", event.Payload))
        // Push notifications sent by chat handler directly
        return nil
    }); err != nil {
        log.Error(ctx, "Failed to subscribe to chat.message", err)
    }
}
```

---

## ‚öôÔ∏è Background Jobs

### **Views Flush Job** (`internal/jobs/views_flush.go`)
```go
type ViewsFlushJob struct {
    interval time.Duration
    stopChan chan bool
}

func NewViewsFlushJob(interval time.Duration) *ViewsFlushJob {
    return &ViewsFlushJob{
        interval: interval,
        stopChan: make(chan bool),
    }
}

func (j *ViewsFlushJob) Start() {
    ticker := time.NewTicker(j.interval)
    ctx := context.Background()

    log.Info(ctx, "ViewsFlushJob started", zap.Duration("interval", j.interval))

    go func() {
        for {
            select {
            case <-ticker.C:
                j.flushViews(ctx)
            case <-j.stopChan:
                ticker.Stop()
                log.Info(ctx, "ViewsFlushJob stopped")
                return
            }
        }
    }()
}

func (j *ViewsFlushJob) flushViews(ctx context.Context) {
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ pending —Å—á–µ—Ç—á–∏–∫–∏
    counters, err := cache.GetAllPendingViewsCounters(ctx)
    if err != nil {
        log.Error(ctx, "Failed to get pending views counters", err)
        return
    }

    if len(counters) == 0 {
        return
    }

    db := database.GetDB()
    if db == nil {
        log.Error(ctx, "Database not available for views flush", nil)
        return
    }

    // –ù–∞—á–∏–Ω–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
    tx, err := db.Begin()
    if err != nil {
        log.Error(ctx, "Failed to begin transaction for views flush", err)
        return
    }
    defer tx.Rollback()

    flushedCount := 0
    for videoID, count := range counters {
        // –û–±–Ω–æ–≤–ª—è–µ–º views –≤ DB
        _, err := tx.Exec(`
            UPDATE videos 
            SET views = views + $1, updated_at = NOW() 
            WHERE id = $2
        `, count, videoID)

        if err != nil {
            log.Error(ctx, "Failed to update views for video", err, 
                zap.Int64("video_id", videoID), 
                zap.Int64("views", count))
            continue
        }

        // –£–¥–∞–ª—è–µ–º –∏–∑ Redis
        _, err = cache.GetAndResetViewsCounter(ctx, videoID)
        if err != nil {
            log.Warn(ctx, "Failed to reset views counter in Redis", 
                zap.Int64("video_id", videoID), 
                zap.Error(err))
        }

        flushedCount++
    }

    // –ö–æ–º–º–∏—Ç–∏–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
    if err := tx.Commit(); err != nil {
        log.Error(ctx, "Failed to commit views flush transaction", err)
        return
    }

    if flushedCount > 0 {
        log.Info(ctx, "Views flushed to database", 
            zap.Int("videos_count", flushedCount),
            zap.Int("total_counters", len(counters)))
    }
}
```

### **Metrics Updater Job** (`internal/jobs/metrics_updater.go`)
```go
type MetricsUpdaterJob struct {
    interval time.Duration
    stopChan chan bool
}

func NewMetricsUpdaterJob(interval time.Duration) *MetricsUpdaterJob {
    return &MetricsUpdaterJob{
        interval: interval,
        stopChan: make(chan bool),
    }
}

func (j *MetricsUpdaterJob) Start() {
    ticker := time.NewTicker(j.interval)
    ctx := context.Background()

    log.Info(ctx, "MetricsUpdaterJob started", zap.Duration("interval", j.interval))

    go func() {
        for {
            select {
            case <-ticker.C:
                j.updateMetrics(ctx)
            case <-j.stopChan:
                ticker.Stop()
                log.Info(ctx, "MetricsUpdaterJob stopped")
                return
            }
        }
    }()
}

func (j *MetricsUpdaterJob) updateMetrics(ctx context.Context) {
    db := database.GetDB()
    if db == nil {
        log.Error(ctx, "Database not available for metrics update", nil)
        return
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    var totalUsers, activeUsers, totalVideos, totalRequests int64
    
    db.QueryRow("SELECT COUNT(*) FROM users").Scan(&totalUsers)
    db.QueryRow("SELECT COUNT(*) FROM users WHERE last_login_at > NOW() - INTERVAL '30 days'").Scan(&activeUsers)
    db.QueryRow("SELECT COUNT(*) FROM videos").Scan(&totalVideos)
    db.QueryRow("SELECT COUNT(*) FROM requests").Scan(&totalRequests)

    // –û–±–Ω–æ–≤–ª—è–µ–º Prometheus –º–µ—Ç—Ä–∏–∫–∏
    metrics.SetTotalUsers(totalUsers)
    metrics.SetActiveUsers(activeUsers)
    metrics.SetTotalVideos(totalVideos)
    metrics.SetTotalRequests(totalRequests)

    log.Debug(ctx, "Metrics updated", 
        zap.Int64("total_users", totalUsers),
        zap.Int64("active_users", activeUsers),
        zap.Int64("total_videos", totalVideos),
        zap.Int64("total_requests", totalRequests))
}
```

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### **Prometheus Metrics** (`internal/metrics/prometheus.go`)
```go
var (
    httpRequestsTotal = prometheus.NewCounterVec(
        prometheus.CounterOpts{
            Name: "http_requests_total",
            Help: "Total number of HTTP requests",
        },
        []string{"method", "endpoint", "status"},
    )

    httpRequestDuration = prometheus.NewHistogramVec(
        prometheus.HistogramOpts{
            Name: "http_request_duration_seconds",
            Help: "HTTP request duration in seconds",
        },
        []string{"method", "endpoint"},
    )

    activeUsers = prometheus.NewGauge(
        prometheus.GaugeOpts{
            Name: "active_users_total",
            Help: "Total number of active users",
        },
    )

    totalVideos = prometheus.NewGauge(
        prometheus.GaugeOpts{
            Name: "videos_total",
            Help: "Total number of videos",
        },
    )
)

func init() {
    prometheus.MustRegister(httpRequestsTotal)
    prometheus.MustRegister(httpRequestDuration)
    prometheus.MustRegister(activeUsers)
    prometheus.MustRegister(totalVideos)
}
```

### **Grafana Dashboard**
- **HTTP Metrics**: –∑–∞–ø—Ä–æ—Å—ã, latency, –æ—à–∏–±–∫–∏
- **Database Metrics**: —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, –∑–∞–ø—Ä–æ—Å—ã, –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- **Redis Metrics**: –ø–∞–º—è—Ç—å, —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, –æ–ø–µ—Ä–∞—Ü–∏–∏
- **Business Metrics**: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –≤–∏–¥–µ–æ, –∑–∞—è–≤–∫–∏, –∑–∞–∫–∞–∑—ã

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤**
```
tests/
‚îú‚îÄ‚îÄ unit/              # Unit —Ç–µ—Å—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ handlers/      # HTTP handlers
‚îÇ   ‚îú‚îÄ‚îÄ services/      # Business logic
‚îÇ   ‚îî‚îÄ‚îÄ entities/      # Domain entities
‚îú‚îÄ‚îÄ integration/       # Integration —Ç–µ—Å—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ api/          # API endpoints
‚îÇ   ‚îú‚îÄ‚îÄ database/     # DB operations
‚îÇ   ‚îî‚îÄ‚îÄ cache/        # Redis operations
‚îú‚îÄ‚îÄ e2e/              # End-to-end —Ç–µ—Å—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ auth/         # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ videos/       # –í–∏–¥–µ–æ workflow
‚îÇ   ‚îî‚îÄ‚îÄ requests/     # –ó–∞—è–≤–∫–∏ workflow
‚îî‚îÄ‚îÄ load/             # Load —Ç–µ—Å—Ç—ã
    ‚îú‚îÄ‚îÄ api/          # API –Ω–∞–≥—Ä—É–∑–∫–∞
    ‚îî‚îÄ‚îÄ database/     # DB –Ω–∞–≥—Ä—É–∑–∫–∞
```

### **Makefile –∫–æ–º–∞–Ω–¥—ã**
```bash
make test-unit        # Unit —Ç–µ—Å—Ç—ã
make test-integration # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
make test-all         # –í—Å–µ —Ç–µ—Å—Ç—ã
make test-coverage    # –û—Ç—á–µ—Ç –ø–æ–∫—Ä—ã—Ç–∏—è
make test-load        # Load —Ç–µ—Å—Ç—ã
```

### **Testcontainers –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤**
```go
func TestVideoUpload(t *testing.T) {
    // –ó–∞–ø—É—Å–∫–∞–µ–º PostgreSQL –∏ Redis –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö
    postgresContainer := testcontainers.PostgreSQLContainer{
        Image: "postgres:15-alpine",
        Database: "testdb",
        Username: "testuser",
        Password: "testpass",
    }
    
    redisContainer := testcontainers.RedisContainer{
        Image: "redis:7-alpine",
    }
    
    // –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É –≤–∏–¥–µ–æ
    // ...
}
```

---

## üîÑ –ë–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å—ã

### **–ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∑–∞—è–≤–∫–∏**
1. **–ö–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–µ—Ç –∑–∞—è–≤–∫—É** ‚Üí —Å—Ç–∞—Ç—É—Å `pending`
2. **–ú–∞—Å—Ç–µ—Ä–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è** ‚Üí —Å—Ç–∞—Ç—É—Å `pending`
3. **–ö–ª–∏–µ–Ω—Ç –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ** ‚Üí —Å—Ç–∞—Ç—É—Å `in_progress`
4. **–°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–∫–∞–∑** ‚Üí —Å—Ç–∞—Ç—É—Å `pending`
5. **–ú–∞—Å—Ç–µ—Ä –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–∫–∞–∑** ‚Üí —Å—Ç–∞—Ç—É—Å `in_progress`
6. **–ó–∞–∫–∞–∑ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è** ‚Üí —Å—Ç–∞—Ç—É—Å `completed`

### **–°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π**
- **Push**: —á–µ—Ä–µ–∑ OneSignal API
- **SMS**: —á–µ—Ä–µ–∑ Mobizon API
- **Email**: —á–µ—Ä–µ–∑ SMTP
- **In-app**: —á–µ—Ä–µ–∑ WebSocket

### **–ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è**
- **–û—á–∫–∏ –∑–∞ –¥–µ–π—Å—Ç–≤–∏—è**: —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ (10), –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (50), –ª–∞–π–∫ (5)
- **–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è**: –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑, 10 –ª–∞–π–∫–æ–≤, 100 –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
- **–£—Ä–æ–≤–Ω–∏**: —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ —Ñ–æ—Ä–º—É–ª–µ `(–æ—á–∫–∏ / 100) + 1`

### **AI –∞–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ**
- **–¢–∏–ø—ã –∞–Ω–∞–ª–∏–∑–∞**: –º–µ–±–µ–ª—å, —Å—Ü–µ–Ω–∞, –æ–±—ä–µ–∫—Ç—ã, —Ç–µ–∫—Å—Ç, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
- **–û–±—Ä–∞–±–æ—Ç–∫–∞**: –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —á–µ—Ä–µ–∑ background job
- **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã**: —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

---

## üé® –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### **Clean Architecture**
- **Domain layer**: –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∏ —Å—É—â–Ω–æ—Å—Ç–∏
- **Service layer**: use cases –∏ –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞
- **Infrastructure layer**: –ë–î, –≤–Ω–µ—à–Ω–∏–µ API
- **Presentation layer**: HTTP handlers

### **Event-driven Architecture**
- **–°–æ–±—ã—Ç–∏—è**: video.uploaded, request.created, chat.message
- **–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏**: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–≤—å—é, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å**: —á–µ—Ä–µ–∑ Redis Pub/Sub

### **Production-ready Features**
- **Graceful shutdown**: –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤
- **Health checks**: –¥–ª—è Kubernetes
- **–ú–µ—Ç—Ä–∏–∫–∏**: –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: structured + –∫–æ–Ω—Ç–µ–∫—Å—Ç
- **Rate limiting**: –∑–∞—â–∏—Ç–∞ –æ—Ç DDoS
- **Security headers**: –∑–∞—â–∏—Ç–∞ –æ—Ç –∞—Ç–∞–∫

### **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**
- **–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ**: stateless API
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: Redis –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞**: background jobs
- **Event-driven**: —Å–ª–∞–±–∞—è —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

---

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**
- **Connection pooling**: 25 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∫ PostgreSQL
- **–ò–Ω–¥–µ–∫—Å—ã**: –ø–æ email, phone, created_at, hashtags
- **GIN –∏–Ω–¥–µ–∫—Å—ã**: –¥–ª—è –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (10 –º–∏–Ω), –≤–∏–¥–µ–æ (15 –º–∏–Ω), feed (3 –º–∏–Ω)

### **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
- **Prometheus –º–µ—Ç—Ä–∏–∫–∏**: latency, throughput, errors
- **Jaeger —Ç—Ä–µ–π—Å–∏–Ω–≥**: distributed tracing
- **Grafana –¥–∞—à–±–æ—Ä–¥—ã**: –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫
- **Health checks**: —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤

---

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### **Environment Variables**
```bash
# Database
DATABASE_URL=postgres://user:pass@host:5432/db

# Redis
REDIS_URL=redis://host:6379

# JWT
JWT_SECRET=your-secret-key
JWT_EXPIRATION=15m

# External Services
ONESIGNAL_APP_ID=your-app-id
ONESIGNAL_API_KEY=your-api-key
MOBIZON_API_KEY=your-mobizon-key

# Monitoring
PROMETHEUS_ENABLED=true
JAEGER_ENDPOINT=http://jaeger:14268/api/traces

# Features
ENABLE_AI_ANALYSIS=true
ENABLE_GAMIFICATION=true
ENABLE_STORIES=true
```

### **config.yml**
```yaml
app:
  name: "MebelPlace API"
  version: "1.0.0"
  environment: "production"
  port: 8080
  log_level: "info"

database:
  url: "${DATABASE_URL}"
  max_connections: 25
  max_idle_connections: 5

redis:
  url: "${REDIS_URL}"
  max_connections: 10

jwt:
  secret: "${JWT_SECRET}"
  expiration: "15m"
  refresh_expiration: "30d"

media:
  max_file_size: 314572800  # 300MB
  allowed_types: ["mp4", "mov", "avi", "webm"]

rate_limiting:
  api_limit: 5000
  api_window: "1m"
  strict_limit: 100
  strict_window: "1m"

features:
  ai_analysis: true
  gamification: true
  stories: true
  calls: true
```

---

## üöÄ Deployment

### **Docker Compose –¥–ª—è Production**
```yaml
version: '3.8'

services:
  api:
    build: .
    ports:
      - "8080:8080"
    environment:
      - DATABASE_URL=postgres://mebelplace:${DB_PASSWORD}@postgres:5432/mebelplace
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET}
      - ONESIGNAL_APP_ID=${ONESIGNAL_APP_ID}
      - ONESIGNAL_API_KEY=${ONESIGNAL_API_KEY}
    depends_on:
      - postgres
      - redis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=mebelplace
      - POSTGRES_USER=mebelplace
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
```

### **Kubernetes Deployment**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mebelplace-api
spec:
  replicas: 3
  selector:
    matchLabels:
      app: mebelplace-api
  template:
    metadata:
      labels:
        app: mebelplace-api
    spec:
      containers:
      - name: api
        image: mebelplace/api:latest
        ports:
        - containerPort: 8080
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: mebelplace-secrets
              key: database-url
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: mebelplace-secrets
              key: redis-url
        livenessProbe:
          httpGet:
            path: /live
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
```

---

## üìã –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**MebelPlace Backend** –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ, –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ–µ –∏ production-ready –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω–æ–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ª—É—á—à–∏—Ö –ø—Ä–∞–∫—Ç–∏–∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:

### **–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**
- ‚úÖ **Clean Architecture** - —á–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å–ª–æ–µ–≤
- ‚úÖ **Comprehensive API** - 30+ –º–æ–¥—É–ª–µ–π, 100+ endpoints
- ‚úÖ **Security** - JWT, rate limiting, input sanitization
- ‚úÖ **Performance** - –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ, –∏–Ω–¥–µ–∫—Å—ã, connection pooling
- ‚úÖ **Monitoring** - Prometheus, Grafana, Jaeger
- ‚úÖ **Testing** - unit, integration, e2e, load tests
- ‚úÖ **Event-driven** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ Redis
- ‚úÖ **Production-ready** - health checks, graceful shutdown

### **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- **99+ –º–∏–≥—Ä–∞—Ü–∏–π** –¥–ª—è —ç–≤–æ–ª—é—Ü–∏–∏ —Å—Ö–µ–º—ã –ë–î
- **–ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è** —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏
- **AI –∞–Ω–∞–ª–∏–∑** –≤–∏–¥–µ–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- **–°—Ç–æ—Ä–∏—Å—ã** —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –∏—Å—Ç–µ—á–µ–Ω–∏–µ–º
- **WebRTC –∑–≤–æ–Ω–∫–∏** –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- **Comprehensive search** –ø–æ –≤—Å–µ–º —Å—É—â–Ω–æ—Å—Ç—è–º

### **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production:**
- **Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è** —Å multi-stage build
- **Kubernetes deployment** —Å health checks
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç–∏–Ω–≥** —á–µ—Ä–µ–∑ Prometheus
- **Distributed tracing** —á–µ—Ä–µ–∑ Jaeger
- **Structured logging** —Å Zap
- **Security headers** –∏ CSRF –∑–∞—â–∏—Ç–∞

–ü—Ä–æ–µ–∫—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –≤—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–≥–æ –º—ã—à–ª–µ–Ω–∏—è –∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é –≤ production —Å—Ä–µ–¥–µ.

---

## üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### **Chunk Upload System** (`internal/chunk/uploader.go`)
–°–∏—Å—Ç–µ–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ –ø–æ —á–∞—Å—Ç—è–º –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ –≤–∏–¥–µ–æ:

```go
type ChunkUploader struct {
    redis      *redis.Client
    uploadDir  string
    chunkSize  int64
}

type ChunkInfo struct {
    UploadID    string `json:"upload_id"`
    ChunkIndex  int    `json:"chunk_index"`
    TotalChunks int    `json:"total_chunks"`
    FileName    string `json:"file_name"`
    FileSize    int64  `json:"file_size"`
}
```

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- **–†–∞–∑–±–∏–≤–∫–∞ –Ω–∞ chunks**: —Ñ–∞–π–ª—ã —Ä–∞–∑–±–∏–≤–∞—é—Ç—Å—è –Ω–∞ —á–∞—Å—Ç–∏ –ø–æ 1MB
- **Redis tracking**: –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏
- **–ê–≤—Ç–æ—Å–±–æ—Ä–∫–∞**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–±–æ—Ä–∫–∞ —Ñ–∞–π–ª–∞ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö —á–∞—Å—Ç–µ–π
- **TTL —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–µ–∫—à–∏—Ö —Å–µ—Å—Å–∏–π
- **Distributed locks**: –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

### **FFmpeg Video Processing** (`internal/ffmpeg/processor.go`)
–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ —Å –ø–æ–º–æ—â—å—é FFmpeg:

```go
type VideoProcessor struct {
    ffmpegPath      string
    segmentsDir     string
    segmentDuration int
}

type ProcessingJob struct {
    VideoID         string `json:"video_id"`
    InputPath       string `json:"input_path"`
    OutputDir       string `json:"output_dir"`
    Quality         string `json:"quality"`
    SegmentDuration int    `json:"segment_duration"`
}
```

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- **HLS —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è**: —Ä–∞–∑–±–∏–≤–∫–∞ –≤–∏–¥–µ–æ –Ω–∞ —Å–µ–≥–º–µ–Ω—Ç—ã –¥–ª—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞
- **Thumbnail generation**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–≤—å—é
- **Duration extraction**: –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤–∏–¥–µ–æ
- **Multiple qualities**: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö –∫–∞—á–µ—Å—Ç–≤
- **Error handling**: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ FFmpeg

### **WebRTC Service** (`internal/webrtc/`)
–ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–æ–≤:

#### **Basic WebRTC Service** (`webrtc_service.go`)
```go
type WebRTCService struct {
    agoraAppID       string
    agoraAppCert     string
    twilioAccountSid string
    twilioApiKey     string
    twilioApiSecret  string
    customStunServers []string
    customTurnServers []TurnServer
    tokenExpiration  time.Duration
    maxTokensPerCall int
}

type WebRTCToken struct {
    Token       string                 `json:"token"`
    Channel     string                 `json:"channel"`
    UID         int64                  `json:"uid"`
    ExpiresAt   int64                  `json:"expires_at"`
    IceServers  []IceServer            `json:"ice_servers"`
    Constraints map[string]interface{} `json:"constraints"`
    Signaling   SignalingConfig        `json:"signaling"`
}
```

#### **Production WebRTC Service** (`production_service.go`)
```go
type ProductionWebRTCService struct {
    redis       *redis.Client
    tokenLimits map[string]int
    config      WebRTCConfig
}

type WebRTCConfig struct {
    AgoraAppID       string
    AgoraAppCert     string
    AgoraTokenExpiry int64
    TwilioAccountSid string
    TwilioApiKey     string
    TwilioApiSecret  string
    TurnServers      []ProductionTurnServer
    MaxTokensPerCall int
    TokenExpiration  time.Duration
    RedisPrefix      string
}
```

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã:**
- **Agora**: –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π SDK —Å HMAC –ø–æ–¥–ø–∏—Å—å—é
- **Twilio**: JWT —Ç–æ–∫–µ–Ω—ã —Å grants
- **Custom**: —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å TURN —Å–µ—Ä–≤–µ—Ä–∞–º–∏

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- **Token limits**: –º–∞–∫—Å–∏–º—É–º 2 —Ç–æ–∫–µ–Ω–∞ –Ω–∞ –∑–≤–æ–Ω–æ–∫
- **Redis validation**: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ —á–µ—Ä–µ–∑ Redis
- **Expiration control**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å—Ç–µ—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
- **HMAC signing**: –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è –ø–æ–¥–ø–∏—Å—å

### **Email Service** (`internal/email/smtp.go`)
–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email:

```go
type SMTPClient struct {
    host     string
    port     string
    username string
    password string
    from     string
    fromName string
    db       *sql.DB
}
```

**–¢–∏–ø—ã –ø–∏—Å–µ–º:**
- **Verification emails**: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email —Å HTML —à–∞–±–ª–æ–Ω–∞–º–∏
- **Welcome emails**: –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–∏—Å—å–º–∞ –Ω–æ–≤—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- **Proposal notifications**: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö
- **HTML templates**: –∫—Ä–∞—Å–∏–≤—ã–µ HTML —à–∞–±–ª–æ–Ω—ã —Å –±—Ä–µ–Ω–¥–∏–Ω–≥–æ–º

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- **Development mode**: —Å–∏–º—É–ª—è—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ dev —Ä–µ–∂–∏–º–µ
- **Database storage**: —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–¥–æ–≤ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ –ë–î
- **Error handling**: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ SMTP
- **Template system**: –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ HTML —à–∞–±–ª–æ–Ω—ã

### **SMS Service** (`internal/sms/mobizon.go`)
–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∏–º SMS –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º Mobizon:

```go
type MobizonClient struct {
    apiURL string
    apiKey string
    client *http.Client
}
```

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- **Kazakhstan phone normalization**: –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∏—Ö –Ω–æ–º–µ—Ä–æ–≤
- **International format**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∫ +7XXXXXXXXXX
- **API integration**: –ø–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Mobizon API
- **Error handling**: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ API
- **Development mode**: —Å–∏–º—É–ª—è—Ü–∏—è –≤ dev —Ä–µ–∂–∏–º–µ

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:**
- `87785421871` ‚Üí `+77785421871`
- `77785421871` ‚Üí `+77785421871`
- `7785421871` ‚Üí `+77785421871`

### **S3 Storage** (`internal/storage/s3.go`)
–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ —Ñ–∞–π–ª–æ–≤–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π S3 –∏ MinIO:

```go
var (
    s3Client   *s3.S3
    bucketName string
)
```

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- **S3/MinIO compatibility**: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ AWS S3 –∏ MinIO
- **Presigned URLs**: –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞/—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
- **Auto bucket creation**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ bucket'–æ–≤
- **Error handling**: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
- **Local fallback**: –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ S3

**API –º–µ—Ç–æ–¥—ã:**
- `GetPresignedUploadURL()` - URL –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
- `GetPresignedDownloadURL()` - URL –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
- `UploadFile()` - –ø—Ä—è–º–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
- `DeleteFile()` - —É–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
- `GetFileURL()` - –ø—É–±–ª–∏—á–Ω—ã–µ URL

### **Thumbnail Worker** (`internal/workers/thumbnail.go`)
–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π worker –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–µ–≤—å—é –≤–∏–¥–µ–æ:

```go
type ThumbnailWorker struct {
    eventBus events.EventBus
    db       *database.DB
}
```

**–ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã:**
1. **Event subscription**: –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ `video.uploaded`
2. **Distributed lock**: –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
3. **FFmpeg processing**: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è 3 —Ä–∞–∑–º–µ—Ä–æ–≤ (320x180, 640x360, 1280x720)
4. **Database update**: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ URL –ø—Ä–µ–≤—å—é –≤ –ë–î
5. **Error handling**: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫

**–†–∞–∑–º–µ—Ä—ã –ø—Ä–µ–≤—å—é:**
- **Small**: 320x180 (–¥–ª—è —Å–ø–∏—Å–∫–æ–≤)
- **Medium**: 640x360 (–æ—Å–Ω–æ–≤–Ω–æ–π —Ä–∞–∑–º–µ—Ä)
- **Large**: 1280x720 (–¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞)

---

## üéØ –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞

**MebelPlace Backend** –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π **enterprise-grade** —Ä–µ—à–µ–Ω–∏–µ —Å –ø–æ–ª–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π:

### **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–∞:**
- ‚úÖ **Clean Architecture** —Å —á–µ—Ç–∫–∏–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º —Å–ª–æ–µ–≤
- ‚úÖ **Event-driven** –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏
- ‚úÖ **Microservices-ready** —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- ‚úÖ **Production-ready** —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º

### **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- ‚úÖ **99+ –º–∏–≥—Ä–∞—Ü–∏–π** –¥–ª—è —ç–≤–æ–ª—é—Ü–∏–∏ –ë–î
- ‚úÖ **Chunk upload** –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
- ‚úÖ **FFmpeg processing** –¥–ª—è –≤–∏–¥–µ–æ
- ‚úÖ **WebRTC** —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π 3 –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
- ‚úÖ **Multi-provider** SMS/Email —Å–∏—Å—Ç–µ–º—ã
- ‚úÖ **S3/MinIO** —Ñ–∞–π–ª–æ–≤–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
- ‚úÖ **Background workers** –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á

### **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- ‚úÖ **JWT —Å RS256** –∞–ª–≥–æ—Ä–∏—Ç–º–æ–º
- ‚úÖ **Rate limiting** –∏ DDoS –∑–∞—â–∏—Ç–∞
- ‚úÖ **Input sanitization** –æ—Ç XSS/SQL injection
- ‚úÖ **CSRF protection** —Å Origin –ø—Ä–æ–≤–µ—Ä–∫–æ–π
- ‚úÖ **Security headers** –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ **Password validation** –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º Google/Apple

### **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- ‚úÖ **Redis –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** —Å TTL
- ‚úÖ **Connection pooling** –¥–ª—è –ë–î
- ‚úÖ **–ò–Ω–¥–µ–∫—Å—ã** –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ **Distributed locks** –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- ‚úÖ **Async processing** —á–µ—Ä–µ–∑ Event Bus

### **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ DevOps:**
- ‚úÖ **Prometheus –º–µ—Ç—Ä–∏–∫–∏** –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- ‚úÖ **Grafana –¥–∞—à–±–æ—Ä–¥—ã** –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
- ‚úÖ **Jaeger —Ç—Ä–µ–π—Å–∏–Ω–≥** –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- ‚úÖ **Health checks** –¥–ª—è Kubernetes
- ‚úÖ **Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è** —Å multi-stage build
- ‚úÖ **Graceful shutdown** —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —Å–∏–≥–Ω–∞–ª–æ–≤

**–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ production deployment** –∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –≤—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –∏–Ω–∂–µ–Ω–µ—Ä–Ω–æ–π –∫—É–ª—å—Ç—É—Ä—ã! üöÄ

